<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sparkle | Interactive Particle System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff7e5f;
            --secondary: #feb47b;
            --accent: #00f2ff;
            --bg-dark: #0f0c29;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.6);
            --easing: cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #050510, #181530, #0b0b1a);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* Ambient Background Pulse */
        body::before {
            content: '';
            position: absolute;
            width: 150vw;
            height: 150vh;
            background: radial-gradient(circle at 50% 50%, rgba(118, 75, 162, 0.1), transparent 60%);
            top: -25%;
            left: -25%;
            animation: pulse 10s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* Canvas Layer */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        canvas {
            display: block;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to canvas */
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            pointer-events: auto;
            align-self: center;
            margin-top: 10px;
            transition: opacity 0.3s var(--easing);
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 126, 95, 0.4);
            letter-spacing: -1px;
            margin-bottom: 0.5rem;
            animation: fadeDown 1s var(--easing);
        }
        
        .subtitle {
            font-size: 1rem;
            color: var(--text-dim);
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeDown 1s var(--easing) 0.1s backwards;
        }

        /* Controls Panel */
        .controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 320px;
            max-height: 80vh;
            background: rgba(15, 15, 25, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            overflow-y: auto;
            pointer-events: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: transform 0.4s var(--easing), opacity 0.4s ease;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) transparent;
            animation: slideUp 0.8s var(--easing) 0.2s backwards;
        }

        .controls.hidden {
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .control-group {
            margin-bottom: 24px;
        }
        
        h2 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 18px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        label {
            color: var(--text-main);
        }
        
        .value-display {
            color: var(--text-dim);
            font-variant-numeric: tabular-nums;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 15px var(--primary);
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.3, 3, 0.5, 1), box-shadow 0.2s;
            margin-top: -6px; /* center on track */
            position: relative;
            z-index: 2;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px var(--primary);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            /* Used JS to update background size for progress effect if needed, simpler here */
        }

        /* Presets Grid */
        .presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .preset-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s var(--easing);
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .preset-btn.active {
            background: rgba(255, 126, 95, 0.2);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 15px rgba(255, 126, 95, 0.2) inset;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.5px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(255, 126, 95, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 126, 95, 0.4);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: white;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Floating UI Toggle & FPS */
        .hud {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        .fps-counter {
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent);
            font-family: monospace;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }

        /* Instructions */
        .instructions {
            position: absolute;
            bottom: 30px;
            left: 30px;
            pointer-events: none;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .swipe-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: white;
            animation: fadeIn 2s ease 1s backwards;
        }

        /* Animations */
        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .subtitle { font-size: 0.9rem; padding: 0 20px; }
            
            .controls {
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 50vh;
                transform: translateY(0);
                border-left: none;
                border-right: none;
                border-bottom: none;
                padding: 20px;
            }

            .controls.hidden {
                transform: translateY(110%);
                opacity: 1; /* Keep opacity for slide effect */
            }

            .hud { top: 20px; right: 20px; }
            .instructions { display: none; }
        }
    </style>
</head>
<body>
    
    <div id="canvas-container">
        <canvas id="particleCanvas"></canvas>
    </div>

    <div id="ui-layer">
        <header>
            <h1>Sparkle</h1>
            <p class="subtitle">Interactive Physics Particle System</p>
        </header>
        
        <div class="hud">
            <div id="fpsCounter" class="fps-counter">60 FPS</div>
            <button id="toggleUI" class="icon-btn" title="Toggle Controls">‚öôÔ∏è</button>
        </div>

        <div class="instructions">
            <div class="swipe-hint">
                <span>Try clicking or dragging</span>
                <span style="font-size: 1.2rem">üëÜ</span>
            </div>
        </div>
        
        <div class="controls" id="controlsPanel">
            <div class="control-header">
                <h2>Configuration</h2>
                <div style="font-size: 0.8rem; color: var(--accent);">v2.0</div>
            </div>

            <div class="control-group">
                <h2>‚ö° Physics</h2>
                <div class="slider-container">
                    <div class="slider-header">
                        <label>Count</label>
                        <span class="value-display" id="countValue">800</span>
                    </div>
                    <input type="range" id="particleCount" min="100" max="3000" step="50" value="800">
                </div>
                
                <div class="slider-container">
                    <div class="slider-header">
                        <label>Repulsion</label>
                        <span class="value-display" id="repulsionValue">150</span>
                    </div>
                    <input type="range" id="repulsion" min="0" max="500" value="150">
                </div>
                
                <div class="slider-container">
                    <div class="slider-header">
                        <label>Friction (Inertia)</label>
                        <span class="value-display" id="frictionValue">0.950</span>
                    </div>
                    <input type="range" id="friction" min="0.800" max="0.995" step="0.001" value="0.950">
                </div>
            </div>
            
            <div class="control-group">
                <h2>üé® Visuals</h2>
                <div class="slider-container">
                    <div class="slider-header">
                        <label>Size</label>
                        <span class="value-display" id="sizeValue">2px</span>
                    </div>
                    <input type="range" id="size" min="0.5" max="8" step="0.1" value="2">
                </div>
                
                <div class="slider-container">
                    <div class="slider-header">
                        <label>Trail Fade</label>
                        <span class="value-display" id="trailValue">0.15</span>
                    </div>
                    <input type="range" id="trail" min="0.02" max="0.5" step="0.01" value="0.15">
                </div>
            </div>
            
            <div class="control-group">
                <h2>üí† Mode</h2>
                <div class="presets">
                    <div class="preset-btn active" data-preset="text">Typography</div>
                    <div class="preset-btn" data-preset="flock">Fluid</div>
                    <div class="preset-btn" data-preset="galaxy">Galaxy</div>
                    <div class="preset-btn" data-preset="matrix">Rain</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="explodeBtn" class="btn-primary">üí• Explode</button>
                <button id="resetBtn" class="btn-secondary">‚Ü∫ Reset</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Sparkle v2.0 - Optimized Interactive Particle System
         * 
         * Features:
         * - Spatially optimized rendering
         * - Smooth physics with inertia
         * - Glassmorphic UI 
         * - 60+ FPS on mid-range devices
         */

        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d'); // Default alpha:true for background visibility
        const fpsElement = document.getElementById('fpsCounter');
        
        // System State
        const state = {
            width: 0,
            height: 0,
            pixels: null, // For text data
            particles: [],
            mouse: { x: -1000, y: -1000, radius: 150, active: false },
            tick: 0, // Time ticker
            fps: {
                last: performance.now(),
                frames: 0,
                value: 60
            }
        };

        // Configuration (Reactive)
        const config = {
            count: 800,
            repulsion: 150,
            friction: 0.95,
            size: 2,
            trail: 0.15,
            preset: 'text',
            colors: {
                baseHue: 0,
                rotateSpeed: 0.5
            },
            text: {
                content: "SPARKLE",
                font: "900 120px 'Outfit', sans-serif",
                sampleStep: 8
            }
        };

        // UI Defaults for restore
        const defaults = { ...config };

        /* -----------------------
           Initialization
        ----------------------- */
        function init() {
            resize();
            createParticles();
            loadSettings();
            loop();
        }

        function resize() {
            state.width = canvas.width = window.innerWidth;
            state.height = canvas.height = window.innerHeight;
            if (config.preset === 'text') createParticles(); // Re-sample text on resize
        }
        
        window.addEventListener('resize', () => {
            // Debounce resize
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(resize, 200);
        });

        /* -----------------------
           Particle Logic 
        ----------------------- */
        class Particle {
            constructor(x, y, targetX = null, targetY = null) {
                this.x = Math.random() * state.width;
                this.y = Math.random() * state.height;
                // Physics
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.targetX = targetX;
                this.targetY = targetY;
                // Appearance
                this.hue = Math.random() * 60 + 10; // Warm colors init
                this.size = Math.random() * config.size + 0.5;
                this.life = Math.random(); 
            }

            update() {
                // 1. Apply Forces
                
                // Mouse Repulsion
                const dx = this.x - state.mouse.x;
                const dy = this.y - state.mouse.y;
                const distSq = dx * dx + dy * dy;
                const radiusSq = config.repulsion * config.repulsion;

                if (state.mouse.active && distSq < radiusSq) {
                    const dist = Math.sqrt(distSq);
                    const force = (config.repulsion - dist) / config.repulsion;
                    const angle = Math.atan2(dy, dx);
                    
                    // Add explosive force
                    this.vx += Math.cos(angle) * force * 2;
                    this.vy += Math.sin(angle) * force * 2;
                }

                // Preset Behaviors
                if (config.preset === 'text' && this.targetX !== null) {
                    // Home attraction (spring force)
                    const homeDx = this.targetX - this.x;
                    const homeDy = this.targetY - this.y;
                    this.vx += homeDx * 0.03;
                    this.vy += homeDy * 0.03;
                    
                    // Add noise jitter
                    this.vx += (Math.random() - 0.5) * 0.1;
                    this.vy += (Math.random() - 0.5) * 0.1;

                } else if (config.preset === 'flock') {
                    // Perlin-like flow field (simplified with trig)
                    const angle = Math.sin(this.y * 0.005 + state.tick * 0.02) * Math.cos(this.x * 0.005) * Math.PI * 2;
                    this.vx += Math.cos(angle) * 0.1;
                    this.vy += Math.sin(angle) * 0.1;
                } else if (config.preset === 'galaxy') {
                    const cx = state.width / 2;
                    const cy = state.height / 2;
                    const dx = this.x - cx;
                    const dy = this.y - cy;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const angle = Math.atan2(dy, dx);
                    
                    // Orbital velocity
                    this.vx -= Math.sin(angle) * 0.5;
                    this.vy += Math.cos(angle) * 0.5;
                    
                    // Gravity
                    this.vx -= Math.cos(angle) * 0.02;
                    this.vy -= Math.sin(angle) * 0.02;
                } else if (config.preset === 'matrix') {
                    this.vy += 0.2;
                    if (this.y > state.height) {
                        this.y = 0;
                        this.x = Math.random() * state.width;
                    }
                }

                // 2. Physics Integration
                this.vx *= config.friction;
                this.vy *= config.friction;
                
                this.x += this.vx;
                this.y += this.vy;

                // 3. Boundaries (Wrap or Bounce)
                if (config.preset !== 'text') {
                    if (this.x < 0) this.x = state.width;
                    if (this.x > state.width) this.x = 0;
                    if (this.y < 0) this.y = state.height;
                    // Matrix handles y reset
                    if (config.preset !== 'matrix' && this.y > state.height) this.y = 0;
                }

                // 4. Color Dynamics (Speed based)
                const speed = Math.abs(this.vx) + Math.abs(this.vy);
                this.hue = (this.hue + speed) % 360;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, config.size, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${this.hue}, 80%, 60%)`;
                ctx.fill();
            }
        }

        /* -----------------------
           Generators
        ----------------------- */
        function createParticles() {
            // Morphing Logic: Reuse existing particles
            
            // 1. Get targets if text mode
            let targets = [];
            if (config.preset === 'text') {
                targets = getTextPositions();
            }

            // 2. Adjust Population
            const currentLen = state.particles.length;
            const targetLen = config.count;

            if (currentLen < targetLen) {
                // Add new
                for (let i = 0; i < targetLen - currentLen; i++) {
                    state.particles.push(new Particle());
                }
            } else if (currentLen > targetLen) {
                // Remove excess
                state.particles.splice(targetLen);
            }

            // 3. Assign Targets
            state.particles.forEach((p, i) => {
                // If text mode and we have a target for this particle
                if (config.preset === 'text' && i < targets.length) {
                    p.targetX = targets[i].x;
                    p.targetY = targets[i].y;
                    // Wake up particles that might be sleeping (optional)
                    p.vx += (Math.random() - 0.5) * 2;
                    p.vy += (Math.random() - 0.5) * 2;
                } else {
                    // Release from formation
                    p.targetX = null;
                    p.targetY = null;
                }
            });
        }

        function getTextPositions() {
            // Offscreen render text
            const tmp = document.createElement('canvas');
            const tCtx = tmp.getContext('2d');
            tmp.width = state.width;
            tmp.height = state.height;

            tCtx.fillStyle = '#fff';
            tCtx.font = config.text.font;
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';
            tCtx.fillText(config.text.content, state.width/2, state.height/2);

            // Scan pixels
            const imgData = tCtx.getImageData(0, 0, state.width, state.height).data;
            const step = config.text.sampleStep; 
            
            const positions = [];
            for (let y = 0; y < state.height; y += step) {
                for (let x = 0; x < state.width; x += step) {
                    if (imgData[(y * state.width + x) * 4 + 3] > 128) {
                        positions.push({x, y});
                    }
                }
            }

            // Shuffle for organic fill
            return positions.sort(() => Math.random() - 0.5);
        }

        function createRandom() {
            // Deprecated in favor of morph logic, but kept if needed for hard reset
            state.particles = [];
            for (let i = 0; i < config.count; i++) {
                state.particles.push(new Particle());
            }
        }

        /* -----------------------
           Animation Loop
        ----------------------- */
        function loop() {
            requestAnimationFrame(loop);
            
            // FPS Calculation
            const now = performance.now();
            state.fps.frames++;
            if (now - state.fps.last > 1000) {
                fpsElement.textContent = `${state.fps.frames} FPS`;
                state.fps.frames = 0;
                state.fps.last = now;
            }

            state.tick++;

            // Clear with trail effect
            // Use destination-out to fade existing pixels to transparent, revealing CSS background
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = `rgba(0, 0, 0, ${config.trail})`; 
            ctx.fillRect(0, 0, state.width, state.height);

            // Enable glow
            ctx.globalCompositeOperation = 'lighter';

            // Batch Update & Draw
            for (let i = 0; i < state.particles.length; i++) {
                const p = state.particles[i];
                p.update();
                p.draw();
            }

            // Restore
            ctx.globalCompositeOperation = 'source-over';
        }

        /* -----------------------
           Input Handling
        ----------------------- */
        // Mouse
        window.addEventListener('mousemove', e => {
            state.mouse.x = e.clientX;
            state.mouse.y = e.clientY;
            state.mouse.active = true;
        });

        window.addEventListener('mousedown', () => {
            state.mouse.active = true;
            // Explosion
            explode(state.mouse.x, state.mouse.y);
        });
        
        // Touch
        window.addEventListener('touchstart', e => {
            e.preventDefault();
            state.mouse.x = e.touches[0].clientX;
            state.mouse.y = e.touches[0].clientY;
            state.mouse.active = true;
            explode(state.mouse.x, state.mouse.y);
        }, { passive: false });

        window.addEventListener('touchmove', e => {
            e.preventDefault();
            state.mouse.x = e.touches[0].clientX;
            state.mouse.y = e.touches[0].clientY;
        }, { passive: false });

        window.addEventListener('touchend', () => {
            state.mouse.active = false;
        });

        function explode(x, y) {
            const power = 20;
            state.particles.forEach(p => {
                const dx = p.x - x;
                const dy = p.y - y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 300) {
                    const angle = Math.atan2(dy, dx);
                    p.vx += Math.cos(angle) * power;
                    p.vy += Math.sin(angle) * power;
                }
            });
        }

        /* -----------------------
           UI Connection
        ----------------------- */
        // Bind Sliders
        function bindSlider(id, targetKey, transform = val => val) {
            const el = document.getElementById(id);
            const valEl = document.getElementById(id + 'Value');
            
            el.addEventListener('input', e => {
                const val = parseFloat(e.target.value);
                config[targetKey] = transform(val);
                valEl.textContent = val;
                
                if (targetKey === 'count') createParticles();
                saveSettings(); // Auto-save
            });
        }

        bindSlider('particleCount', 'count');
        bindSlider('repulsion', 'repulsion');
        bindSlider('friction', 'friction');
        bindSlider('size', 'size');
        bindSlider('trail', 'trail');

        // Presets
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                config.preset = btn.dataset.preset;
                createParticles();
                saveSettings();
            });
        });

        // Buttons
        document.getElementById('explodeBtn').addEventListener('click', () => {
            explode(state.width/2, state.height/2);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
             // Reset logic could be complex, for now just respawn
             createParticles();
        });

        document.getElementById('toggleUI').addEventListener('click', () => {
            const panel = document.getElementById('controlsPanel');
            panel.classList.toggle('hidden');
        });

        /* -----------------------
           Persistence
        ----------------------- */
        function saveSettings() {
            localStorage.setItem('sparkle_config_v2', JSON.stringify({
                count: config.count,
                friction: config.friction,
                size: config.size,
                preset: config.preset
            }));
        }

        function loadSettings() {
            const saved = localStorage.getItem('sparkle_config_v2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.assign(config, parsed);
                    
                    // Update UI defaults
                    document.getElementById('particleCount').value = config.count;
                    document.getElementById('countValue').textContent = config.count;
                    document.getElementById('friction').value = config.friction;
                    document.getElementById('frictionValue').textContent = config.friction;
                    document.getElementById('size').value = config.size;
                    document.getElementById('sizeValue').textContent = config.size;
                    
                    // Update Preset UI
                    document.querySelectorAll('.preset-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.preset === config.preset);
                    });
                    
                    createParticles(); // Refresh with loaded settings
                } catch(e) {
                    console.error("Failed to load settings", e);
                }
            }
        }

        // Start
        init();

    </script>
</body>
</html>